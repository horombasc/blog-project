<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - My Blog</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <h1>Admin Panel</h1>
        <a href="/">Back to Blog</a>
    </header>

    <section>
        <h2>Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter admin password">
        <button onclick="login()">Login</button>
        <p id="loginMessage"></p>
    </section>

    <section id="adminContent" style="display: none;">
        <h2>Upload Family Photos</h2>
        <form id="photoForm">
            <input type="file" name="photos" accept="image/*" multiple>
            <button type="submit">Upload Photos</button>
        </form>
        <div id="photoList"></div>

        <h2>Write a Post</h2>
        <form id="postForm">
            <input type="text" name="title" placeholder="Post Title" required>
            <textarea name="content" placeholder="Post Content" required></textarea>
            <select name="category">
                <option value="blog">Blog Post</option>
                <option value="news">Local News</option>
            </select>
            <button type="submit">Add Post</button>
        </form>
        <div id="postList"></div>

        <h2>Moderate Comments</h2>
        <div id="pendingComments"></div>

        <h2>Contact Messages</h2>
        <div id="contactList"></div>
    </section>

    <footer>
        <p>Â© 2025 My Personal Blog</p>
    </footer>

    <script>
        let adminPassword = null;

        function login() {
            adminPassword = document.getElementById('adminPassword').value;
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('loginMessage').textContent = 'Logged in!';
            setupForms();
            loadAdminContent();
        }

        function setupForms() {
            document.getElementById('photoForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const res = await fetch('/api/photos', {
                    method: 'POST',
                    headers: { 'Authorization': adminPassword },
                    body: formData
                });
                if (res.ok) {
                    alert('Photos uploaded!');
                    loadPhotos();
                } else {
                    alert('Upload failed. Check password.');
                }
            };

            document.getElementById('postForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 
                        'Authorization': adminPassword,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Post added!');
                    e.target.reset();
                    loadPosts();
                } else {
                    alert('Post failed. Check password.');
                }
            };
        }

        async function loadAdminContent() {
            loadPhotos();
            loadPosts();
            loadPendingComments();
            loadContacts();
        }

        async function loadPhotos() {
            const res = await fetch('/api/photos', { headers: { 'Authorization': adminPassword } });
            const photos = await res.json();
            const photoList = document.getElementById('photoList');
            photoList.innerHTML = photos.map(p => `
                <div>
                    <img src="/images/${p.filename}" style="max-width: 100px;">
                    <button onclick="deletePhoto(${p.id})">Delete</button>
                </div>
            `).join('');
        }

        async function loadPosts() {
            const res = await fetch('/api/posts', { headers: { 'Authorization': adminPassword } });
            const posts = await res.json();
            const postList = document.getElementById('postList');
            postList.innerHTML = posts.map(p => `
                <div>
                    <h3>${p.title}</h3>
                    <p>${p.content}</p>
                    <small>${p.date} (${p.category})</small>
                    <button onclick="deletePost(${p.id})">Delete</button>
                </div>
            `).join('');
        }

        async function loadPendingComments() {
            try {
                const res = await fetch('/api/comments/pending', { 
                    headers: { 'Authorization': adminPassword } 
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error(`Fetch failed: ${res.status} - ${errorText}`);
                    document.getElementById('pendingComments').innerHTML = `<p>Error loading comments: ${res.status} - ${errorText}</p>`;
                    return;
                }
                const comments = await res.json();
                console.log('Pending comments:', comments);
                const commentList = document.getElementById('pendingComments');
                if (comments.length === 0) {
                    commentList.innerHTML = '<p>No pending comments.</p>';
                } else {
                    commentList.innerHTML = comments.map(c => `
                        <div>
                            <p>${c.content} <small>${c.date}</small></p>
                            <button onclick="approveComment(${c.id})">Approve</button>
                            <button onclick="deleteComment(${c.id})">Delete</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error in loadPendingComments:', error);
                document.getElementById('pendingComments').innerHTML = '<p>Failed to load comments. Check console for details.</p>';
            }
        }

        async function loadContacts() {
            const res = await fetch('/api/contacts', { headers: { 'Authorization': adminPassword } });
            const contacts = await res.json();
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = contacts.map(c => `
                <div>
                    <p><strong>${c.name}</strong> (${c.email}): ${c.message} <small>${c.date}</small></p>
                </div>
            `).join('');
        }

        async function deletePhoto(id) {
            if (confirm('Delete this photo?')) {
                const res = await fetch(`/api/photos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) loadPhotos();
                else alert('Delete failed.');
            }
        }

        async function deletePost(id) {
            if (confirm('Delete this post?')) {
                const res = await fetch(`/api/posts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) loadPosts();
                else alert('Delete failed.');
            }
        }

        async function approveComment(id) {
            const res = await fetch(`/api/comments/approve/${id}`, {
                method: 'POST',
                headers: { 'Authorization': adminPassword }
            });
            if (res.ok) {
                loadPendingComments();
            } else {
                alert('Approval failed.');
            }
        }

        async function deleteComment(id) {
            if (confirm('Delete this comment?')) {
                const res = await fetch(`/api/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) {
                    loadPendingComments();
                } else {
                    alert('Delete failed.');
                }
            }
        }
    </script>
</body>
</html>