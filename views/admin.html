<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - My Blog</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.tiny.cloud/1/ku1ccouns9do9xnbzctzbkx3cfjt1qrvbg0ubx1yuqzxmnt7/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <header>
        <h1>Admin Panel</h1>
        <a href="/">Back to Blog</a>
    </header>

    <section>
        <h2>Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter admin password">
        <button onclick="login()">Login</button>
        <p id="loginMessage"></p>
    </section>

    <section id="adminContent" style="display: none;">
        <h2>Upload Family Photos</h2>
        <form id="photoForm">
            <input type="file" name="photos" accept="image/*" multiple>
            <button type="submit">Upload Photos</button>
        </form>
        <div id="photoList"></div>

        <h2>Write a Post</h2>
        <form id="postForm">
            <input type="text" name="title" placeholder="Post Title" required>
            <textarea name="content" id="postContent" placeholder="Post Content" required></textarea>
            <select name="category">
                <option value="blog">Blog Post</option>
                <option value="news">Local News</option>
            </select>
            <button type="submit">Add Post</button>
        </form>
        <div id="postList"></div>

        <h2>Moderate Comments</h2>
        <div id="pendingComments"></div>

        <h2>Contact Messages</h2>
        <div id="contactList"></div>
    </section>

    <footer>
        <p>Â© 2025 My Personal Blog</p>
    </footer>

    <script>
        let adminPassword = null;

        function login() {
            adminPassword = document.getElementById('adminPassword').value;
            console.log('Admin password set to:', adminPassword);
            document.getElementById('adminContent').style.display = 'block';
            document.getElementById('loginMessage').textContent = 'Logged in!';
            setupForms();
            loadAdminContent();
        }

        function setupForms() {
            tinymce.init({
                selector: '#postContent',
                plugins: 'lists',
                toolbar: 'undo redo | bold italic | alignleft aligncenter alignright | bullist numlist',
                menubar: false,
                height: 300,
                setup: (editor) => {
                    editor.on('init', () => {
                        editor.setContent('');
                        console.log('TinyMCE initialized');
                    });
                }
            });

            document.getElementById('photoForm').onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const res = await fetch('/api/photos', {
                    method: 'POST',
                    headers: { 'Authorization': adminPassword },
                    body: formData
                });
                if (res.ok) {
                    alert('Photos uploaded!');
                    loadPhotos();
                } else {
                    const errorText = await res.text();
                    alert(`Upload failed: ${res.status} - ${errorText}`);
                }
            };

            document.getElementById('postForm').onsubmit = async (e) => {
                e.preventDefault();
                const title = document.querySelector('#postForm input[name="title"]').value;
                const content = tinymce.get('postContent')?.getContent() || '';
                const category = document.querySelector('#postForm select[name="category"]').value;
                console.log('Submitting post:', { title, content, category });
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 
                        'Authorization': adminPassword,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, category })
                });
                if (res.ok) {
                    alert('Post added!');
                    document.querySelector('#postForm input[name="title"]').value = '';
                    tinymce.get('postContent').setContent('');
                    loadPosts();
                } else {
                    const errorText = await res.text();
                    alert(`Post failed: ${res.status} - ${errorText}`);
                }
            };
        }

        async function loadAdminContent() {
            loadPhotos();
            loadPosts();
            loadPendingComments();
            loadContacts();
        }

        async function loadPhotos() {
            const res = await fetch('/api/photos', { headers: { 'Authorization': adminPassword } });
            const photos = await res.json();
            document.getElementById('photoList').innerHTML = photos.map(p => `
                <div>
                    <img src="/images/${p.filename}" style="max-width: 100px;">
                    <button onclick="deletePhoto(${p.id})">Delete</button>
                </div>
            `).join('');
        }

        async function loadPosts() {
            const res = await fetch('/api/posts', { headers: { 'Authorization': adminPassword } });
            const posts = await res.json();
            document.getElementById('postList').innerHTML = posts.map(p => `
                <div>
                    <h3>${p.title}</h3>
                    <div>${p.content}</div>
                    <small>${formatDate(p.date)} (${p.category})</small>
                    <button onclick="deletePost(${p.id})">Delete</button>
                </div>
            `).join('');
        }

        async function loadPendingComments() {
            const res = await fetch('/api/comments/pending', { headers: { 'Authorization': adminPassword } });
            if (!res.ok) {
                const errorText = await res.text();
                document.getElementById('pendingComments').innerHTML = `<p>Error: ${res.status} - ${errorText}</p>`;
                return;
            }
            const comments = await res.json();
            document.getElementById('pendingComments').innerHTML = comments.length === 0 
                ? '<p>No pending comments.</p>'
                : comments.map(c => `
                    <div>
                        <p>${c.content} <small>${formatDate(c.date)}</small></p>
                        <button onclick="approveComment(${c.id})">Approve</button>
                        <button onclick="deleteComment(${c.id})">Delete</button>
                    </div>
                `).join('');
        }

        async function loadContacts() {
            const res = await fetch('/api/contacts', { headers: { 'Authorization': adminPassword } });
            const contacts = await res.json();
            document.getElementById('contactList').innerHTML = contacts.map(c => `
                <div>
                    <p><strong>${c.name}</strong> (${c.email}): ${c.message} <small>${formatDate(c.date)}</small></p>
                </div>
            `).join('');
        }

        async function deletePhoto(id) {
            if (confirm('Delete this photo?')) {
                const res = await fetch(`/api/photos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) loadPhotos();
                else alert('Delete failed.');
            }
        }

        async function deletePost(id) {
            if (confirm('Delete this post?')) {
                const res = await fetch(`/api/posts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) loadPosts();
                else alert('Delete failed.');
            }
        }

        async function approveComment(id) {
            const res = await fetch(`/api/comments/approve/${id}`, {
                method: 'POST',
                headers: { 'Authorization': adminPassword }
            });
            if (res.ok) loadPendingComments();
            else alert('Approval failed.');
        }

        async function deleteComment(id) {
            if (confirm('Delete this comment?')) {
                const res = await fetch(`/api/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': adminPassword }
                });
                if (res.ok) loadPendingComments();
                else alert('Delete failed.');
            }
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
